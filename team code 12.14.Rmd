---
title: "Code structure"
output: html_document
---

## Data exploration and cleaning

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(faraway)
library(HH)
library(leaps)
library(caret)
library('glmnet')                         # for glmnet()
library(boot)                          # For cv.glm()
library(MPV)

reg1 <- c("Connecticut", "Maine", "Massachusetts", "New Hampshire", "Rhode Island", "Vermont")

reg2 <- c("New Jersey", "New York", "Puerto Rico", "US Virgin Islands")

reg3 <- c("Delaware", 'District of Columbia', 'Maryland', 'Pennsylvania', 'Virginia', 'West Virginia')

reg4 <- c('Alabama', 'Florida', 'Georgia', 'Kentucky', 'Mississippi', 'North Carolina', 'South Carolina', 'Tennessee')

reg5 <- c('Illinois', 'Indiana', 'Michigan', 'Minnesota', 'Ohio', 'Wisconsin')

reg6 <- c('Arkansas', 'Louisiana', 'New Mexico', 'Oklahoma', 'Texas')

reg7 <- c('Iowa', 'Kansas', 'Missouri', 'Nebraska')

reg8 <- c('Colorado', 'Montana', 'North Dakota', 'South Dakota', 'Utah', 'Wyoming')

reg9 <- c('Arizona', 'California', 'Hawaii', 'Nevada', 'American Samoa', 'Guam', 'Northern Mariana Islands')

reg10 <- c('Alaska', 'Idaho', 'Oregon', 'Washington')



NE.name <- c("Connecticut","Maine","Massachusetts","New Hampshire",
             "Rhode Island","Vermont","New Jersey","New York",
             "Pennsylvania")

MW.name <- c("Indiana","Illinois","Michigan","Ohio","Wisconsin",
             "Iowa","Kansas","Minnesota","Missouri","Nebraska",
             "North Dakota","South Dakota")

S.name <- c("Delaware","District of Columbia","Florida","Georgia",
            "Maryland","North Carolina","South Carolina","Virginia",
            "West Virginia","Alabama","Kentucky","Mississippi",
            "Tennessee","Arkansas","Louisiana","Oklahoma","Texas")

W.name <- c("Arizona","Colorado","Idaho","New Mexico","Montana",
            "Utah","Nevada","Wyoming","Alaska","California",
            "Hawaii","Oregon","Washington")
```


```{r}
# import data
cancer = read_csv('./data/Cancer_Registry.csv') %>%
  janitor::clean_names() %>%
  mutate(state = str_replace(str_extract(geography, ', .*'), ', ', ''), # group counties by state
         log_ann_count = log(avg_ann_count), # log transformations
         log_deaths_yr = log(avg_deaths_per_year),
         log_pop = log(pop_est2015),
         pct_black_bin = ifelse(pct_black >= 5, 1, 0), # add small decimal 
         pct_asian_bin = ifelse(pct_asian >= 5, 1, 0),
         pct_other_race_bin = ifelse(pct_other_race >= 5, 1, 0),
         region = ifelse(state %in% NE.name, 'Northeast', NA), # bin states by geographic region
         region = ifelse(state %in% MW.name, 'Midwest', region),
         region = ifelse(state %in% S.name, 'South', region),
         region = ifelse(state %in% W.name, 'West', region),
         fed_region = ifelse(state %in% reg1, 'Region 1', NA),
         fed_region = ifelse(state %in% reg2, 'Region 2', fed_region),
         fed_region = ifelse(state %in% reg3, 'Region 3', fed_region),
         fed_region = ifelse(state %in% reg4, 'Region 4', fed_region),
         fed_region = ifelse(state %in% reg5, 'Region 5', fed_region),
         fed_region = ifelse(state %in% reg6, 'Region 6', fed_region),
         fed_region = ifelse(state %in% reg7, 'Region 7', fed_region),
         fed_region = ifelse(state %in% reg8, 'Region 8', fed_region),
         fed_region = ifelse(state %in% reg9, 'Region 9', fed_region),
         fed_region = ifelse(state %in% reg10, 'Region 10', fed_region))


# selection of variables based on our exploration 
cancer_varselect = cancer %>%
  dplyr::select(target_death_rate,
                log_ann_count,
                incidence_rate,
                med_income,
                poverty_percent,
                study_per_cap,
                median_age_male,
                avg_household_size,
                percent_married,
                pct_bach_deg25_over,
                pct_black_bin,
                pct_asian_bin,
                pct_other_race_bin,
                pct_private_coverage,
                pct_public_coverage,
                fed_region)


```


```{r}
cancer %>%
  group_by(fed_region) %>%
  ggplot(aes(y = target_death_rate, x = fed_region)) + 
  geom_violin()

cancer %>%
  group_by(region) %>%
  ggplot(aes(y = target_death_rate, x = region)) + 
  geom_violin()
```


We first examined variables for any skewness, and then tested associations between covariates to identify potential sources of collinearity. We found that several sets of variables were correlated. 

We saw that median age was highly skewed, to the point that we think there is some sort of data error. Keep this in mind for later; for now we remove from the list of selected parameters. It's also interesting to note that median age between males and females are highly correlated eith each other, but not much correlated with target death rate. In fact, median age in males is negatively correlated with death rate, while median age for females is positively correlated.

We looked again at the variables for the percent of the population of a certain race and found that log transformation was bimodal. It might make sense to make this binary (i.e. >5% of a certain race or not).

groups: 
avg_ann_count, avg_deaths_per_year, pop_est2015
poverty_percent, binned_inc
pct_bach_25, pct_hs25
pct_white, pct_black





## Model selection

### Stepwise

```{r}
#Really full model
b.fit = lm(target_death_rate ~ ., data = cancer_varselect)
summary(b.fit)
summary(lm(target_death_rate ~ . - poverty_percent, data = cancer_varselect))
summary(lm(target_death_rate ~ . - avg_household_size, data = cancer_varselect))
summary(lm(target_death_rate ~ . - avg_household_size - study_per_cap, data = cancer_varselect))
summary(lm(target_death_rate ~ . - avg_household_size - study_per_cap - pct_asian_bin, data = cancer_varselect))
summary(lm(target_death_rate ~ . - avg_household_size - study_per_cap - pct_asian_bin - poverty_percent, data = cancer_varselect))

#Model 1
step.fit = step(b.fit)
summary(step.fit)
```

## Lasso Model Selection
```{r}
## Lasso on selected variables
set.seed(1)
Y <- cancer_varselect$target_death_rate
#X <- model.matrix(~ log_ann_count + incidence_rate + med_income + poverty_percent + study_per_cap + 
#                  median_age_male + avg_household_size + percent_married + pct_bach_deg25_over + #pct_black_bin + pct_asian_bin + pct_other_race_bin + pct_private_coverage + pct_public_coverage + #state, data = cancer3)

X <- model.matrix( ~ . , data = cancer_varselect[,-1])
train <- sample(1:nrow(X), nrow(X)/2)
grid <- 10^seq(5, -2, length = 100)

lasso1 <- glmnet(X[train ,],Y[train], alpha = 1, lambda = grid)
cv.out <- cv.glmnet(X[train,],Y[train]) # all possible lambda values
plot(cv.out) # CV process

coef(glmnet(X, Y, alpha = 1, lambda = cv.out$lambda.min)) # fitting with chosen lambda
(glmnet(X, Y, alpha = 1, lambda = cv.out$lambda.min))$dev.ratio
```





## Model validation

Leave-one-out cross validation

```{r}
## LOOCV

glm.fit <- glm(target_death_rate ~ log_ann_count + incidence_rate + med_income + median_age_male + percent_married + pct_bach_deg25_over + pct_black_bin + pct_other_race_bin + pct_private_coverage + pct_public_coverage + region, data = cancer_varselect)

glm.fit <- glm(target_death_rate ~ log_ann_count + incidence_rate + poverty_percent + median_age_male + percent_married + pct_bach_deg25_over + pct_other_race_bin + pct_private_coverage + pct_public_coverage + fed_region, data = cancer_varselect)


cv.err <- cv.glm(cancer_varselect, glm.fit)

# The two delta values should be similar: we use the first one
# The second value is bias corrected
sqrt(cv.err$delta)[2] # RMSE
```

K-fold CV

```{r}
kfold_cv = lapply(1:10, function(i){
  # create 10-fold training datasets
  data_train <- trainControl(method = "cv", number = 10)

  # Fit the model used above
  model_caret <- train((target_death_rate ~ log_ann_count + incidence_rate + med_income +
                          median_age_male + percent_married + pct_bach_deg25_over + pct_black_bin +
                          pct_other_race_bin + pct_private_coverage + pct_public_coverage + region),
                     data = cancer_varselect,
                     trControl = data_train,
                     method = 'lm',
                     na.action = na.pass)
  
  #return(list(model_caret$results, model_caret$resample))
  return(model_caret$results)
})

do.call("rbind", kfold_cv) %>%
  dplyr::select(RMSE, RMSESD) %>% # summarise(mse = mean(RMSE))
  mutate(MSE = RMSE^2,
         std.error = RMSESD / 9) %>%
  dplyr::select(1, 3, 2, 4) %>% summarise(mse = mean(MSE),
                                          rmse = mean(RMSE),
                                          se = mean(std.error))
```


10-fold and N-fold cross validation show root MSE of ~19.5. 


Criterion comparison

```{r}
newsummary <- function(model)
{
    list('coefs'    = round(t(summary(model)$coef[, 1:2]), 4),
         'criteria' = cbind('SSE'   = anova(model)["Residuals", "Sum Sq"],
                            'PRESS' = PRESS(model),
                            'MSE'   = anova(model)["Residuals", "Mean Sq"],
                            'Rsq'   = summary(model)$adj.r.squared))
}

newsummary(lm(target_death_rate ~ log_ann_count + incidence_rate + med_income + median_age_male + percent_married + pct_bach_deg25_over + pct_black_bin + pct_other_race_bin + pct_private_coverage + pct_public_coverage + region, data = cancer_varselect))

```

